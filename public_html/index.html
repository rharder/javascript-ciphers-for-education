<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link href="js/libs/jquery-ui-1.11.2/jquery-ui.css" rel='stylesheet' type='text/css'>
<script src="js/libs/jquery/jquery.js"></script>
<script src="js/libs/jquery-ui-1.11.2/jquery-ui.js"></script>
<script src="js/libs/highcharts/highcharts.js"></script>
<script src="js/libs/object-watch/object-watch.js"></script>

<script language="javascript"><!--
// Backup graph libraries to try:
// http://raphaeljs.com
// https://github.com/eoinmurray/histogram
// https://google-developers.appspot.com/chart/interactive/docs/quick_start

/*
Sl, M lezi wpmttih xli wyvpc fsrhw sj ievxl, 
Erh hergih xli womiw sr peyklxiv-wmpzivih amrkw; 
Wyraevh M'zi gpmqfih erh nsmrih xli xyqfpmrk qmvxl sj wyr-wtpmx gpsyhw - 
erh hsri e lyrhvih xlmrkw Csy lezi rsx hvieqih sj - 
aliipih erh wsevih erh wayrk lmkl mr xli wyrpmx wmpirgi. 
Lszivmrk xlivi M'zi glewih xli wlsyxmrk amrh epsrk 
erh jpyrk qc iekiv gvejx xlvsykl jssxpiww leppw sj emv.
"Yt, yt xli psrk hipmvmsyw fyvrmrk fpyi 
M'zi xsttih xli amrh-waitx limklxw amxl iewc kvegi, 
alivi riziv pevo, sv izir iekpi, jpia; 
erh, almpi amxl wmpirx, pmjxmrk qmrh M'zi xvsh 
xli lmkl yrxviwtewwih wergxmxc sj wtegi, 
tyx syx qc lerh erh xsyglih xli jegi sj Ksh.
 */

var ShiftCipher = {
    
    ALPHABET_LOWER : ['a','b','c','d','e','f','g','h','i','j','k','l','m',
                          'n','o','p','q','r','s','t','u','v','w','x','y','z'],
    
    ALPHABET_UPPER : ['A','B','C','D','E','F','G','H','I','J','K','L','M',
                          'N','O','P','Q','R','S','T','U','V','W','X','Y','Z'],

    // http://www.cryptograms.org/letter-frequencies.php
    ENGLISH_FREQUENCIES : [0.08167, 0.01492, 0.02782, 0.04253, 0.12702, 0.02228,
                           0.02015, 0.06094, 0.06966, 0.00153, 0.00772, 0.04025,
                           0.02406, 0.06749, 0.07507, 0.01929, 0.00095, 0.05987,
                           0.06327, 0.09056, 0.02758, 0.00978, 0.02360, 0.00150,
                           0.01974, 0.00074],

    _freqChart : null,
    _cipherText : "",
    _originalShift : 0,
    _paddedFrequencies : [],
    _plainText : "",
    _plainTextCache : {},
    _listeners : {},
    
    
    addEventListener : function( eventType, callback ){
        if( this._listeners[eventType] == null ){
            this._listeners[eventType] = [callback];
        } else {
            this._listeners[eventType].push(callback);
        }
    },
    
    fireEvent : function( eventType, arg ){
        if( this._listeners[eventType] != null ){
            this._listeners[eventType].map(function(callback){
                callback(arg);
            });
        }
    },
    
    get cipherText() { return this._cipherText; },
    set cipherText ( text ){
        if( text === this._cipherText ) return;
        this._cipherText = text;
        this._plainTextCache = {}; // Clear cached deciphered contents
        this.paddedFrequencies = this.frequenciesPaddedAlphabet( this.cipherText );
        //this.updateFrequencies();
        this.updateChart();
        this.fireEvent( "cipherTextChanged", this );
        this.fireEvent( "plainTextChanged", this );
    },
    
    get originalShift() { return this._originalShift; },
    set originalShift ( shift ){
        if( shift === this._originalShift ) return;
        this._originalShift = shift;
        this.updateChart();
        this.fireEvent( "originalShiftChanged", this );
        this.fireEvent( "plainTextChanged", this );
    },
    
    get plainText() {
        if( this._plainTextCache[this.originalShift] == null ){
            this._plainTextCache[this.originalShift] = 
                this.decipher( this.cipherText, this.originalShift );
        }
        return this._plainTextCache[this.originalShift];
    },
    //set plainText( text ){ 
    //    this._plainTextCache[this.originalShift] = text;
    //},
    
    get paddedFrequencies() { return this._paddedFrequencies; },
    set paddedFrequencies(pf) { this._paddedFrequencies = pf; },
    
    

    /**
     * Shifts the given text, maintaining case and preserving
     * non-latin characters (non a-z).  For example a call
     * with the text "cat" and a shift of 2 would return "ecv".
     */
    decipher : function ( text, origShift ){
        var output = '';
        var c;
        for( var i = 0; i < text.length; i++ ){
            c = text.charCodeAt(i);
            if( c >= 65 && c <= 90 ){
                output += String.fromCharCode( (c - 65 + 26-origShift ) % 26 + 65 );
            } else if( c >= 97 && c <= 122 ){
                output += String.fromCharCode( (c - 97 + 26-origShift) %26 + 97 );
            } else {
                output += text.charAt(i);
            }
        }
        return output;
    },
    
    
    shiftArray : function ( input, origShift/*0..26*/ ){
        var output = [];
        for( var i = 0; i < input.length; i++ ){
            output[i] = input[ (i+origShift) % input.length ];
        }
        return output;
    },
    
    
    /**
     * Returns the frequencies of characters in the text.
     * The returned value is a dictionary with every character
     * in the source text as a key (even punctuation, etc).
     */
    frequenciesCountChars : function( text ){
        var freqs = {};
        var c;
        for( var i = 0; i < text.length; i++ ){
            c = text.charAt(i);
            freqs[c] = freqs[c] ? freqs[c] + 1 : 1;
        }
        return freqs;
    },
    
    frequenciesPaddedAlphabet : function( text ){
        var rawFreqs = this.frequenciesCountChars( text );
        var paddedFreqs = [];
        var totalChars = 0;
        for( var i = 0; i < this.ALPHABET_UPPER.length; i++ ){
            var count = 0;
            if( !isNaN( rawFreqs[this.ALPHABET_LOWER[i]] ) ){
                count += rawFreqs[this.ALPHABET_LOWER[i]]
            }
            if( !isNaN( rawFreqs[this.ALPHABET_UPPER[i]] ) ){
                count += rawFreqs[this.ALPHABET_UPPER[i]]
            }
            paddedFreqs[ i ] = count;
            totalChars += count;
        }
        for( var i = 0; i < paddedFreqs.length; i++ ){
            paddedFreqs[i] = 1.0 * paddedFreqs[i] / totalChars;
        }
        return paddedFreqs;
    },
    
    
    initChart : function( container ){
        
        if( this._freqChart == null ){
            this._freqChart = new Highcharts.Chart({
                chart: {
                    renderTo: 'container',
                    type: 'column'
                },
                colors: ['@111111', '#dd1111'],
                plotOptions: {
                                column: {
                                    grouping: false,
                                    shadow: false
                                }
                            },
                title: {
                    text: null//'Frequency Analysis'
                },
                xAxis: {
                    categories: this.ALPHABET_UPPER
                },
                yAxis: {
                    title: {
                        text: 'Frequency'
                    }
                },
                series: [{
                    name: 'English',
                    data: this.ENGLISH_FREQUENCIES,
                    pointPadding: 0
                }, {
                    name: 'Ciphertext',
                    pointPadding: 0.2
                    //data: this.shiftArray(paddedFreqs,shift)
                }]
            });
        } 
    },
    
    updatePlainText : function(){
        alert("don't call updatePlainText anymore");
/*        if( this._plainTextCache[this.originalShift] == null ){
            this.plainText = this.decipher( this.cipherText, this.originalShift );
        }
        this.fireEvent( "plainTextChanged", this.plainText );
*/        
    },
    
    updateChart : function(){
        this._freqChart.series[1].setData(this.shiftArray(this.paddedFrequencies,this.originalShift));
    },
    
    /**
     * Updates frequency data inside the given element.
     */
    updateFrequencies : function(){
        alert("don't call updateFrequencies anymore");
        this.paddedFrequencies = this.frequenciesPaddedAlphabet( this.cipherText );
    },
    

    addEvent : function( target, eventName, func, capture ){
        if( target.addEventListener ){
            target.addEventListener( eventName, func, capture );
            return true;
        }   // end if: addEventListener
        else if( target.attachEvent )
            return target.attachEvent( 'on'+eventName, func );
    },  // end addEvent


    removeEvent : function( target, eventName, func, capture ){
        if( target.removeEventListener ){
            target.removeEventListener( eventName, func, capture );
            return true;
        }   // end if: removeEventListener
        else if( target.detachEvent )
            return target.detachEvent( 'on'+eventName, func );
    },   // end removeEvent
    

};  // end ShiftCipher

function shiftInputChange(){
    var inEl = document.getElementById('shiftinput');
    var outEl = document.getElementById('shiftoutput');
    var shiftEl = document.getElementById('shiftamount');
    var freqEl = document.getElementById('freqout');
    
    shiftCipher.cipherText = inEl.value ;
}

function shiftAmountChange(){
    var shiftEl = document.getElementById('shiftamount');
    
    shiftCipher.originalShift = parseInt(shiftEl.value) ;
    
//    outEl.value = ShiftCipher.shiftText(inEl.value,parseInt(shiftEl.value));
//    shiftCipher.updateFrequencies( outEl.value, parseInt(shiftEl.value) );
    
    
}

function pageInit(){
    var inEl = document.getElementById('shiftinput');
    var outEl = document.getElementById('shiftoutput');
    var shiftEl = document.getElementById('shiftamount');
    
    shiftCipher.initChart('container');
    shiftCipher.shift = parseInt(shiftEl.value) ;
    
    shiftCipher.addEvent(inEl,'input',shiftInputChange,false);
    shiftCipher.addEvent(inEl,'onpropertychange',shiftInputChange,false);
    
    shiftCipher.addEvent(shiftEl,'input',shiftAmountChange,false);
    shiftCipher.addEvent(shiftEl,'onpropertychange',shiftAmountChange,false);
    
    shiftCipher.addEventListener( "plainTextChanged", function(src){
        outEl.innerHTML = "Plain: " + src.plainText;
    });
    shiftCipher.addEventListener( "originalShiftChanged", function(src){
        shiftEl.value = src.originalShift;
        $( "#slider" ).slider({ value: src.originalShift });
    });
    shiftCipher.cipherText = inEl.innerHTML;
}

var shiftCipher = Object.create( ShiftCipher );
//ShiftCipher.addEvent(window,'load',pageInit,false);
$( document ).ready(function() {
    pageInit();
    //$( "#slider" ).slider();
});
$(function() {
    $( "#slider" ).slider({
          value:4,
          min: 0,
          max: 26,
          step: 1,
          slide: function( event, ui ) {
            shiftCipher.originalShift = ui.value ;
          }
        });
});

/*
shiftCipher.watch("shift",function(prop,oldVal,newVal){
    var el = document.getElementById('el');
    el.innerHTML =  "Prop=" + prop + ", oldVal=" + oldVal + ", newVal=" + newVal + "<br>val=" + shiftCipher.shift;
});
*/

// --></script>
</head>
<body>
    <div id="el"></div>
<h1>Shift Cipher</h1>
Input:
<textarea id="shiftinput">Sl, M lezi wpmttih xli wyvpc fsrhw sj ievxl, 
Erh hergih xli womiw sr peyklxiv-wmpzivih amrkw; 
Wyraevh M'zi gpmqfih erh nsmrih xli xyqfpmrk qmvxl sj wyr-wtpmx gpsyhw - 
erh hsri e lyrhvih xlmrkw Csy lezi rsx hvieqih sj - 
aliipih erh wsevih erh wayrk lmkl mr xli wyrpmx wmpirgi. 
Lszivmrk xlivi M'zi glewih xli wlsyxmrk amrh epsrk 
erh jpyrk qc iekiv gvejx xlvsykl jssxpiww leppw sj emv.
"Yt, yt xli psrk hipmvmsyw fyvrmrk fpyi 
M'zi xsttih xli amrh-waitx limklxw amxl iewc kvegi, 
alivi riziv pevo, sv izir iekpi, jpia; 
erh, almpi amxl wmpirx, pmjxmrk qmrh M'zi xvsh 
xli lmkl yrxviwtewwih wergxmxc sj wtegi, 
tyx syx qc lerh erh xsyglih xli jegi sj Ksh.</textarea>

Original Shift:
<input type="text" id="shiftamount" value="2" />
<div id="slider" style="width:200px;" ></div>

Output:
<textarea id="shiftoutput"></textarea>

<div id="freqout">freqs</div>
<div id="container" style="width:100%; height:15em;"></div>

</body>
</html>